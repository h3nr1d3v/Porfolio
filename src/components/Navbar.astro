---
import ThemeToggle from "./ThemeToggle.astro";
---

<div class="w-full flex justify-center">
  <header
    id="navbar"
    class="fixed top-0 z-50 w-[95%] sm:w-auto rounded-full mt-4 bg-light-primary/50 dark:bg-dark-primary/50 backdrop-blur-sm shadow-lg transition-all duration-300"
  >
    <nav class="px-4 sm:px-6 py-3" aria-label="Main navigation">
      <div class="flex items-center justify-between">
        <div class="hidden md:flex items-center space-x-4 lg:space-x-8">
          <a
            href="#hero"
            class="nav-link text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text-dark-tertiary transition-all duration-300 flex items-center gap-2"
            aria-label="About section"
          >
            <i class="fas fa-user" aria-hidden="true"></i>
            <span>About</span>
          </a>
          <a
            href="#skills"
            class="nav-link text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text-dark-tertiary transition-all duration-300 flex items-center gap-2"
            aria-label="Skills section"
          >
            <i class="fas fa-code" aria-hidden="true"></i>
            <span>Skills</span>
          </a>
          <a
            href="#experience"
            class="nav-link text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text-dark-tertiary transition-all duration-300 flex items-center gap-2"
            aria-label="Experience section"
          >
            <i class="fas fa-briefcase" aria-hidden="true"></i>
            <span>Experience</span>
          </a>
          <a
            href="#projects"
            class="nav-link text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text-dark-tertiary transition-all duration-300 flex items-center gap-2"
            aria-label="Projects section"
          >
            <i class="fas fa-project-diagram" aria-hidden="true"></i>
            <span>Projects</span>
          </a>
          <a
            href="#certifications"
            class="nav-link text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text-dark-tertiary transition-all duration-300 flex items-center gap-2"
            aria-label="Certifications section"
          >
            <i class="fas fa-certificate" aria-hidden="true"></i>
            <span>Certifications</span>
          </a>
          <a
            href="#education"
            class="nav-link text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text-dark-tertiary transition-all duration-300 flex items-center gap-2"
            aria-label="Education section"
          >
            <i class="fas fa-graduation-cap" aria-hidden="true"></i>
            <span>Education</span>
          </a>
          <a
            href="#contact"
            class="nav-link text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text-dark-tertiary transition-all duration-300 flex items-center gap-2"
            aria-label="Contact section"
          >
            <i class="fas fa-globe" aria-hidden="true"></i>
            <span>Contact</span>
          </a>
          <ThemeToggle />
        </div>
        <div class="flex items-center justify-between w-full md:w-auto">
          <button
            id="mobile-menu-button"
            class="md:hidden text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text-dark-tertiary transition-all duration-300"
            aria-label="Toggle mobile menu"
            aria-expanded="false"
            aria-controls="mobile-menu"
          >
            <i class="fas fa-bars text-2xl"></i>
          </button>
          <div class="md:hidden">
            <ThemeToggle />
          </div>
        </div>
      </div>
    </nav>
  </header>
</div>

<div
  id="mobile-menu"
  class="fixed inset-0 md:hidden hidden z-40 bg-black/50"
  aria-hidden="true"
>
  <div class="min-h-screen w-full flex flex-col">
    <div class="mt-20 mx-auto w-[90%] max-w-md">
      <div
        class="w-full p-4 space-y-2 bg-light-primary dark:bg-dark-primary rounded-lg shadow-lg backdrop-blur-md"
        role="navigation"
        aria-label="Mobile navigation"
      >
        <a
          href="#hero"
          class="nav-link block w-full px-4 py-3 rounded-md text-base font-medium text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text-dark-tertiary hover:bg-light-secondary dark:hover:bg-dark-secondary transition-all duration-300"
          aria-label="About section"
        >
          <i class="fas fa-user mr-2" aria-hidden="true"></i>
          About
        </a>
        <a
          href="#skills"
          class="nav-link block w-full px-4 py-3 rounded-md text-base font-medium text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text-dark-tertiary hover:bg-light-secondary dark:hover:bg-dark-secondary transition-all duration-300"
          aria-label="Skills section"
        >
          <i class="fas fa-code mr-2" aria-hidden="true"></i>
          Skills
        </a>
        <a
          href="#experience"
          class="nav-link block w-full px-4 py-3 rounded-md text-base font-medium text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text-dark-tertiary hover:bg-light-secondary dark:hover:bg-dark-secondary transition-all duration-300"
          aria-label="Experience section"
        >
          <i class="fas fa-briefcase mr-2" aria-hidden="true"></i>
          Experience
        </a>
        <a
          href="#projects"
          class="nav-link block w-full px-4 py-3 rounded-md text-base font-medium text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text-dark-tertiary hover:bg-light-secondary dark:hover:bg-dark-secondary transition-all duration-300"
          aria-label="Projects section"
        >
          <i class="fas fa-project-diagram mr-2" aria-hidden="true"></i>
          Projects
        </a>
        <a
          href="#certifications"
          class="nav-link block w-full px-4 py-3 rounded-md text-base font-medium text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text- dark-tertiary hover:bg-light-secondary dark:hover:bg-dark-secondary transition-all duration-300"
          aria-label="Certifications section"
        >
          <i class="fas fa-certificate mr-2" aria-hidden="true"></i>
          Certifications
        </a>
        <a
          href="#education"
          class="nav-link block w-full px-4 py-3 rounded-md text-base font-medium text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text-dark-tertiary hover:bg-light-secondary dark:hover:bg-dark-secondary transition-all duration-300"
          aria-label="Education section"
        >
          <i class="fas fa-graduation-cap mr-2" aria-hidden="true"></i>
          Education
        </a>
        <a
          href="#contact"
          class="nav-link block w-full px-4 py-3 rounded-md text-base font-medium text-light-accent dark:text-dark-accent hover:text-light-tertiary dark:hover:text-dark-tertiary hover:bg-light-secondary dark:hover:bg-dark-secondary transition-all duration-300"
          aria-label="Contact section"
        >
          <i class="fas fa-globe mr-2" aria-hidden="true"></i>
          Contact
        </a>
      </div>
    </div>
  </div>
</div>

<style>
  @media (max-width: 768px) {
    #mobile-menu {
      animation: fadeIn 0.2s ease-out;
    }

    #mobile-menu > div {
      animation: slideDown 0.3s ease-out;
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideDown {
    from {
      transform: translateY(-10%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    #mobile-menu,
    #mobile-menu > div {
      animation: none;
    }
  }

  .nav-link {
    position: relative;
    overflow: hidden;
  }

  .nav-link::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: currentColor;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
  }

  .nav-link:hover::after,
  .nav-link:focus::after {
    transform: translateX(0);
  }

  @media (prefers-reduced-motion: reduce) {
    .nav-link::after {
      transition: none;
    }
  }
</style>

<script>
  let lastScrollY = window.scrollY;
  let activeSection: string | null = null;
  let touchStartY = 0;

  function updateActiveSection() {
    const sections = document.querySelectorAll<Element>("section[id]");
    const scrollPosition = window.scrollY + window.innerHeight / 3;

    sections.forEach((section) => {
      const sectionTop = section.getBoundingClientRect().top + window.scrollY;
      const sectionHeight = section.clientHeight;
      const sectionId = section.getAttribute("id");

      if (
        scrollPosition >= sectionTop &&
        scrollPosition < sectionTop + sectionHeight &&
        sectionId
      ) {
        if (activeSection !== sectionId) {
          activeSection = sectionId;
          updateNavLinks();
        }
      }
    });
  }

  function updateNavLinks() {
    document.querySelectorAll(".nav-link").forEach((link) => {
      const href = link.getAttribute("href")?.substring(1);
      if (href === activeSection) {
        link.classList.add("text-light-secondary", "dark:text-dark-secondary");
      } else {
        link.classList.remove(
          "text-light-secondary",
          "dark:text-dark-secondary"
        );
      }
    });
  }

  function toggleMobileMenu(force?: boolean) {
    const mobileMenu = document.getElementById("mobile-menu");
    const menuButton = document.getElementById("mobile-menu-button");
    const body = document.body;

    if (mobileMenu && menuButton) {
      const isExpanded =
        force !== undefined
          ? !force
          : menuButton.getAttribute("aria-expanded") === "true";

      mobileMenu.classList.toggle("hidden", isExpanded);
      menuButton.setAttribute("aria-expanded", (!isExpanded).toString());
      mobileMenu.setAttribute("aria-hidden", isExpanded.toString());
      body.style.overflow = isExpanded ? "" : "hidden";
    }
  }

  function handleTouchStart(e: TouchEvent) {
    touchStartY = e.touches[0].clientY;
  }

  function handleTouchMove(e: TouchEvent) {
    const touchEndY = e.touches[0].clientY;
    const diff = touchStartY - touchEndY;

    if (Math.abs(diff) > 50) {
      toggleMobileMenu(true);
    }
  }

  document.addEventListener("astro:page-load", () => {
    const mobileMenuButton = document.getElementById("mobile-menu-button");
    const mobileMenu = document.getElementById("mobile-menu");

    if (mobileMenuButton && mobileMenu) {
      mobileMenuButton.addEventListener("click", () => toggleMobileMenu());

      // Touch events for swipe to close
      mobileMenu.addEventListener("touchstart", handleTouchStart, {
        passive: true,
      });
      mobileMenu.addEventListener("touchmove", handleTouchMove, {
        passive: true,
      });

      // Close menu when clicking outside
      document.addEventListener("click", (e) => {
        if (
          !mobileMenu.contains(e.target as Node) &&
          !mobileMenuButton.contains(e.target as Node) &&
          !mobileMenu.classList.contains("hidden")
        ) {
          toggleMobileMenu(true);
        }
      });

      // Close menu when clicking a link
      document.querySelectorAll(".nav-link").forEach((link) => {
        link.addEventListener("click", () => {
          if (window.innerWidth < 768) {
            toggleMobileMenu(true);
          }
        });
      });

      // Handle escape key
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !mobileMenu.classList.contains("hidden")) {
          toggleMobileMenu(true);
        }
      });
    }

    // Handle scroll events
    window.addEventListener(
      "scroll",
      () => {
        const navbar = document.getElementById("navbar");
        if (navbar) {
          if (lastScrollY < window.scrollY && window.scrollY > 100) {
            navbar.style.transform = "translateY(-150%)";
          } else {
            navbar.style.transform = "translateY(0)";
          }
          lastScrollY = window.scrollY;
        }
        updateActiveSection();
      },
      { passive: true }
    );

    // Initialize active section
    updateActiveSection();
  });
</script>
